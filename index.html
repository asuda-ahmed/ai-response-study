<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Response Voting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .description {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .description p {
            font-size: 1.2rem;
            color: #2d3748;
            line-height: 1.6;
        }

        .setup-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .setup-section h2 {
            margin-bottom: 20px;
            color: #4a5568;
        }

        .config-note {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #744210;
        }

        .config-note strong {
            color: #c05621;
        }

        .code-example {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #2d3748;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .voting-section {
            display: none;
        }

        .progress-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .progress-container {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
        }

        .meal-description {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .meal-description h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .meal-description p {
            font-size: 1.1rem;
            color: #2d3748;
            line-height: 1.5;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .response-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .response-card:hover {
            transform: translateY(-5px);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f7fafc;
        }

        .response-label {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a5568;
        }

        .model-index {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #2d3748;
        }

        .response-content {
            line-height: 1.6;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1rem;
            min-height: 200px;
            overflow-y: auto;
        }

        .vote-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            font-size: 1.1rem;
            padding: 15px;
            margin-bottom: 10px;
        }

        .vote-btn:hover {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .neither-btn {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
        }

        .neither-btn:hover {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .voting-actions {
            text-align: center;
            margin-top: 20px;
        }

        .neither-container {
            text-align: center;
            margin: 30px 0;
        }

        .submit-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }

        .submit-section h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-size: 1.2rem;
            padding: 15px 30px;
            margin: 10px;
        }

        .continue-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            font-size: 1.2rem;
            padding: 15px 30px;
            margin: 10px;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1rem;
            color: white;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c53030;
        }

        .success {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #276749;
        }

        .instructions {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #2b6cb0;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #2d3748;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .comparison-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .response-content {
                min-height: 150px;
                font-size: 0.95rem;
            }

            .setup-section {
                padding: 20px;
            }

            .code-example {
                font-size: 12px;
            }

            .description {
                padding: 20px;
            }

            .description p {
                font-size: 1.1rem;
            }
        }
        .spinner {
          border: 6px solid #f3f3f3; /* Light grey */
          border-top: 6px solid #3498db; /* Blue */
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: auto;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è AI Meal Analysis Voting ü§ñ</h1>
        </div>

        <div class="description">
            <p>We asked two AI models to analyze the healthiness of this meal and suggest any improvements. We got these two responses - <strong>which one do you prefer?</strong> ü§î</p>
        </div>

        <div id="loading" style="text-align:center; margin:20px;">
            <div class="spinner"></div>
            <p>Loading responses...</p>
          </div>

        <div id="votingSection" class="voting-section">
            <div class="progress-bar">
                <div class="progress-container">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Vote 1 of 5 üéØ</div>
            </div>

            <div id="mealDescription" class="meal-description" style="display: none;">
                <h3>üçΩÔ∏è Meal Description</h3>
                <p id="mealText"></p>
            </div>

            <div id="comparisonContainer" class="comparison-container">
                <div class="response-card">
                    <div class="response-header">
                        <span class="response-label" id="labelA">Response A</span>
                        <span class="model-index" id="modelA"></span>
                    </div>
                    <div class="response-content" id="responseA"></div>
                    <button class="btn vote-btn" onclick="vote(0)" id="voteABtn">üëç Prefer This Response</button>
                </div>

                <div class="response-card">
                    <div class="response-header">
                        <span class="response-label" id="labelB">Response B</span>
                        <span class="model-index" id="modelB"></span>
                    </div>
                    <div class="response-content" id="responseB"></div>
                    <button class="btn vote-btn" onclick="vote(1)" id="voteBBtn">üëç Prefer This Response</button>
                </div>
            </div>

            <div class="neither-container">
                <button class="btn neither-btn" onclick="voteNeither()">ü§∑ Neither - Both are equally good/bad</button>
            </div>

            <div id="submitSection" class="submit-section">
                <h3>üéâ Great job! You've completed 5 votes!</h3>
                <p style="margin-bottom: 20px; color: #4a5568;">What would you like to do next?</p>
                <button class="btn submit-btn" onclick="submitVotes()">‚úÖ Submit My Votes & Finish</button>
                <button class="btn continue-btn" onclick="continueVoting()">‚ûï Do 5 More Votes</button>
            </div>

            <div id="status" class="status"></div>
        </div>
    </div>

    <script>
        // üîß CONFIGURE THIS: Replace with your Google Apps Script web app URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzeJsOoWYvKzVvuGYpHVc0BZSL05Y8uG2aYC44WuN-ccF3YiwGS_ErqA9XjOO7Sg69j/exec';
        
        let unvotedRows = [];
        let currentPair = [];
        let votesInCurrentSession = 0;
        let totalVotes = 0;
        let userId = '';

        // Generate unique user ID automatically
        function generateUserId() {
            // Try to get existing user ID from session storage first
            let existingId = sessionStorage.getItem('voting_user_id');
            if (existingId) {
                return existingId;
            }

            // Create browser fingerprint
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            const canvasFingerprint = canvas.toDataURL();

            // Collect browser info
            const browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvas: canvasFingerprint.slice(-50), // Last 50 chars
                timestamp: Date.now()
            };

            // Create hash from browser info
            let hash = 0;
            const str = JSON.stringify(browserInfo);
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }

            // Create user ID: timestamp + hash + random
            const timestamp = Date.now().toString(36);
            const hashStr = Math.abs(hash).toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            const newUserId = `user_${timestamp}_${hashStr}_${random}`;

            // Store in session storage
            sessionStorage.setItem('voting_user_id', newUserId);
            
            return newUserId;
        }

        function showError(message) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function showSuccess(message) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
        }

        function showLoading(message) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="loading"><div class="spinner"></div>${message}</div>`;
        }

        function updateProgress() {
            const progress = (votesInCurrentSession / 5) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `Vote ${votesInCurrentSession + 1} of 5 üéØ`;
        }

        async function initializeApp() {
            if (APPS_SCRIPT_URL.includes('YOUR_SCRIPT_ID_HERE')) {
                showError('Please configure the APPS_SCRIPT_URL variable in the code first! üîß');
                return;
            }

            // Generate unique user ID
            userId = generateUserId();
            console.log('User ID generated:', userId);

            showLoading('Loading responses... üìä');

            try {
                await loadUnvotedRows();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('votingSection').style.display = 'block';
                votesInCurrentSession = 0;
                updateProgress();
                await loadNextPair();
            } catch (error) {
                showError(`Failed to initialize: ${error.message}`);
            }
        }

        async function loadUnvotedRows() {
            const url = `${APPS_SCRIPT_URL}?action=getUnvoted`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch data from Google Apps Script');
            }

            unvotedRows = await response.json();

            if (!Array.isArray(unvotedRows) || unvotedRows.length < 2) {
                throw new Error('Need at least 2 unvoted responses to compare');
            }
        }

        async function loadNextPair() {
            if (unvotedRows.length < 2) {
                showSuccess('All responses have been voted on! üéâ');
                return;
            }

            // Group unvoted rows by Response_Index to ensure we compare responses from the same meal
            const responseGroups = {};
            unvotedRows.forEach(row => {
                const responseIndex = row.responseIndex;
                if (!responseGroups[responseIndex]) {
                    responseGroups[responseIndex] = [];
                }
                responseGroups[responseIndex].push(row);
            });

            // Find groups that have exactly 2 responses (a complete pair)
            const availablePairs = Object.values(responseGroups).filter(group => group.length === 2);

            if (availablePairs.length === 0) {
                showSuccess('All complete response pairs have been voted on! üéâ');
                return;
            }

            // Randomly select one of the available pairs
            const randomPairIndex = Math.floor(Math.random() * availablePairs.length);
            currentPair = availablePairs[randomPairIndex];

            // Randomly decide which response goes on which side to avoid bias
            const shouldSwap = Math.random() < 0.5;
            if (shouldSwap) {
                currentPair = [currentPair[1], currentPair[0]];
            }

            // Display the responses
            document.getElementById('modelA').textContent = `Model ${currentPair[0].modelIndex}`;
            document.getElementById('responseA').innerHTML = marked.parse(currentPair[0].promptOutput);
            document.getElementById('modelB').textContent = `Model ${currentPair[1].modelIndex}`;
            document.getElementById('responseB').innerHTML = marked.parse(currentPair[1].promptOutput);

            // Show meal description (both responses should have the same meal description)
            const mealDesc = currentPair[0].mealDescription || currentPair[1].mealDescription;
            if (mealDesc) {
                document.getElementById('mealText').textContent = mealDesc;
                document.getElementById('mealDescription').style.display = 'block';
            } else {
                document.getElementById('mealDescription').style.display = 'none';
            }

            document.getElementById('status').innerHTML = `<p style="color: white;">üí™ Available pairs remaining: ${availablePairs.length}</p>`;
        }

        async function vote(chosenIndex) {
            await recordVote(chosenIndex, 'normal');
        }

        async function voteNeither() {
            await recordVote(-1, 'neither');
        }

        async function recordVote(chosenIndex, voteType) {
            showLoading('Recording your vote... üìù');

            const winnerRow = currentPair[0];
            const loserRow = currentPair[1];

            try {
                let url;
                if (voteType === 'neither') {
                    url = `${APPS_SCRIPT_URL}?action=vote&winnerRow=${winnerRow.rowIndex}&loserRow=${loserRow.rowIndex}&votetype=neither&userId=${encodeURIComponent(userId)}`;
                } else {
                    const actualWinner = currentPair[chosenIndex];
                    const actualLoser = currentPair[1 - chosenIndex];
                    url = `${APPS_SCRIPT_URL}?action=vote&winnerRow=${actualWinner.rowIndex}&loserRow=${actualLoser.rowIndex}&votetype=normal&userId=${encodeURIComponent(userId)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to record vote');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error('Vote recording failed');
                }

                // Remove both rows from unvoted list
                unvotedRows = unvotedRows.filter(row => 
                    row.rowIndex !== winnerRow.rowIndex && row.rowIndex !== loserRow.rowIndex
                );

                votesInCurrentSession++;
                totalVotes++;

                let message = '';
                if (voteType === 'neither') {
                    message = 'ü§ù Neither response selected - marked as tie!';
                } else {
                    message = `üëç Vote recorded! Response ${chosenIndex === 0 ? 'A' : 'B'} wins.`;
                }
                
                showSuccess(message);

                // Check if we've completed 5 votes
                if (votesInCurrentSession >= 5) {
                    document.getElementById('submitSection').style.display = 'block';
                    document.getElementById('comparisonContainer').style.display = 'none';
                    document.getElementById('mealDescription').style.display = 'none';
                    document.querySelector('.neither-container').style.display = 'none';
                    return;
                }

                updateProgress();

                // Load next pair after a short delay
                setTimeout(async () => {
                    await loadNextPair();
                }, 1500);

            } catch (error) {
                showError(`Failed to record vote: ${error.message}`);
            }
        }

        async function submitVotes() {
            showSuccess(`üéâ Thank you! You completed ${totalVotes} total votes. Your responses have been recorded!`);
            document.getElementById('submitSection').innerHTML = `
                <h3>‚ú® Thank you for participating! ‚ú®</h3>
                <p style="color: #4a5568; font-size: 1.1rem; margin: 20px 0;">
                    You completed <strong>${totalVotes} votes</strong> in total. Your feedback is valuable! üôè
                </p>
                <button class="btn" onclick="location.reload()">üîÑ Start Over (New Session)</button>
            `;
        }

        async function continueVoting() {
            votesInCurrentSession = 0;
            updateProgress();
            document.getElementById('submitSection').style.display = 'none';
            document.getElementById('comparisonContainer').style.display = 'grid';
            document.querySelector('.neither-container').style.display = 'block';
            await loadNextPair();
        }
        this.initializeApp();
    </script>
</body>
</html>